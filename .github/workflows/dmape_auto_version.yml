name: DMAPE Auto Version

on:
  pull_request:
    paths:
      - "prompts/base/**"

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-version:
    if: github.actor != 'dmape-bot'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Generate versioned prompt from base
        run: |
          ./scripts/local_generate_version.sh

      - name: Review latest version
        run: |
          LATEST=$(ls prompts/versions | tail -n 1)
          ./scripts/review_version.sh "$LATEST"

      - name: Promote latest version
        run: |
          LATEST=$(ls prompts/versions | tail -n 1)
          ./scripts/promote_version.sh "$LATEST"

      - name: Block on quarantine
        run: |
          STATUS=$(jq -r '.promotion_status' artifacts/status/*/status.json | tail -n 1)
          if [ "$STATUS" = "quarantine" ]; then
            echo "‚ùå DMAPE quarantined this prompt"
            exit 1
          fi

      - name: Create Pull Request with enhanced prompt
        uses: peter-evans/create-pull-request@v6
        with:
          branch: dmape/auto-version
          delete-branch: true
          title: "DMAPE auto: enhanced prompt version"
          commit-message: "DMAPE auto: add enhanced prompt version"
          body: |
            This PR was generated automatically by DMAPE.

            - Base prompts unchanged
            - Enhanced prompt added under prompts/versions/
            - Review + promotion gates passed
